<html>
<head>
  <title>Continuous SoundCloud Player</title>
  <link href='http://fonts.googleapis.com/css?family=Aldrich' rel='stylesheet' type='text/css'>
  <link href='css/core.css' rel='stylesheet' type='text/css'>
  <script type="text/javascript" src="js/jquery.min.js"></script>
  <script type="text/javascript" src="sm2/soundmanager2-nodebug-jsmin.js"></script>
  <script type="text/javascript" src="js/player.js"></script>
  <script type="text/javascript" src="js/info.js"></script>
  <script type="text/javascript" src="js/play.js"></script>
  <script type="text/javascript" src="js/progress.js"></script>
  <script type="text/javascript" src="js/loading.js"></script>
  <script type="text/javascript" src="js/volume.js"></script>
  <script type="text/javascript" src="js/waveform.js"></script>
  <script type="text/javascript" src="js/overlay.js"></script>
</head>
<body>
  <div id="ui" class="ui-box">
    <div id="player"></div>

    <div id="playlist">
      <div id="buttons" class="ui-box">
        <ul>
          <li class="unselectable playlist"><a href="#playlist">playlist (<span class="count">0</span>)</a></li>
          <li class="unselectable groups"><a href="#groups">groups (<span class="count">0</span>)</a></li>
          <li class="unselectable help"><a href="#help">help</a></li>
          <li class="unselectable about"><a href="#about">about</a></li>
        </ul>
      </div>
      <div class="content scroller">
        <ul class="playlist"></ul>

        <div class="groups">
          <input type="text" name="group" class="group-name" value="" />
          <a href="#" class="add-group">+</a>

          <div class="no-groups">
            <h1>It looks like there are no groups here!</h1>
            <p>
              To get started, type a SoundCloud group in the box and press enter or click the plus!<br />
            <p>
            <p>
              Examples include: dubstep, dnb, rock, metal, etc...
            </p>
            <h1>How do I find more groups?</h1>
            <p>
              Head over to <a target="_blank" href="http://soundcloud.com/groups">SoundCloud groups</a> and navigate to a group that interests you.
            </p>
            <p><img src="img/finding-groups.png" /></p>
            <p>
              Now enter the last part of the url (highlighted in red in the image).
            </p>
            <p><img src="img/enter-group-name.png" /></p>
          </div>

          <ul class="group-list"></ul>

        </div>

        <div class="help">
          <h1>Basic Usage</h1>
          <p>
            Using this player is simple just add some groups and you'll be off!
          </p>

          <h1>Keyboard Shortcuts</h1>
          <ul>
            <li>up arrow - volume up</li>
            <li>down arrow - volume down</li>
            <li>left arrow - previous track</li>
            <li>right arrow - next track</li>
            <li>space - toggle pause</li>
            <li>] - seek 500ms into the future</li>
            <li>[ - seek 500ms into the past</li>
          </p>

          <h1>If things go horribly wrong</h1>
          <p>
            Click <a class="reset" href="#">here</a> and everything will be reset.
          </p>
        </div>

        <div class="about">
        <h1>Another SoundCloud player?</h1>
        <p>
          So, I was sick of how SoundCloud plays through groups and thought about how it could be fixed.
        </p>
        <p>
          Currently, SoundCloud plays tracks in reverse chronological order.  This is problematic because you will end up hearing
          the same tracks over and over if you let it stream on.  This player solves that problem by playing tracks in chronological order.
        </p>
        <p>
          When you add a group, the latest tracks will be immediately added to your playlist. After each track is played, soundcloud is queried and a new set of tracks are retrieved. As long as people are uploading tracks you will continue to hear new music!
        </p>
        <p>
          To add to the fun, your exact state is stored in localStorage. If you refresh or accidentally close the tab, your next visit will land you in the exact state you were in before you navigated away from the page!
        </p>

        <h1>Built by</h1>
        <p>
          Developed by <a target="_blank" href="http://twitter.com/tmpvar">@tmpvar</a><br />
          Designed by <a target="_blank" href="">@exploderh2</a>
        </p>

        <h1>Open source</h1>
        <p>
          As always, this project is open source! Fork me on <a target="_blank" href="http://github.com/tmpvar/soundcloud-player">github</a>
        </p>

        </div>


      </div>
    </div>
  </div>

  <script type="text/javascript">
    $(function() {
      var storage = window.storage = JSON.parse(localStorage.getItem('state') || '{ "tracks" : [], "groups" : [] }');

      var save = function() {
        localStorage.setItem('state', JSON.stringify(storage));
      };

      window.reset = function() {
        storage = {
          groups : {},
          tracks : []
        }
        save();
        window.location.reload();
      };

      $('.reset').click(function(e) {
        e.preventDefault();
        e.stopImmediatePropagation();
        reset();
      })

      var player = window.player = new Player({
        selector      : '#player',
        width : 400,
        height: 400,
        volume : storage.volume || 70, // in percent
        soundcloud : {
          key    : 'bc73a3deaf438619d689a1100a066ce1',
        },
        soundManager  : {
          url : 'sm2/swf/',
          flashVersion : 9,
          useFlashBlock : false
        },
        theme : {
          progress : {
            background : {
              color : 'rgba(0,0,0,0.4)',
              radius : 196
            },
            buffering : { // buffer bar
              radius: 110,
              color : "#b0b0b0"
            },
            playing : {
              radius: 196, // waveform highlighter height
              color: "#11db11"
            },
            bufferOverlay : { // buffer bar overlay
              radius: 110,
              color : "rgba(1, 0, 1, 0.5)"
            },
            inner : { // innermost circle
              radius : 105,
              color : 'black'
            }
          },
          waveform : {
            slices : 600, // number of slices to cut the sound cloud wave form into
            height : 100, // height of the waveform to render
            offset : 197, // translate this far off of the center
            color  : "rgba(0,0,0,1)", // color of the waveform
            background : "rgba(255,255,255,1)", // color behind the waveform
            replace : 'white', // initial color that the waveform replaces
            compositeOperations : {
              replace : 'source-over', // bottom of the stack
              background : 'source-out', // replace the waveform
              slice : 'destination-out',
            },
            outerWidth: 5 // skew the waveform slice so it is bigger on the outside of the circle
          },
          loading : {

            slices: 50, // total number of slices
            speed : 4, // fall speed of slices
            rate : 16, // time between slice changes
            fade : {
              hide : 700, // time to fade in in ms
              show : 100 // time to fade out in ms
            },
            inner: {
              radius : 50, // inner circle radius
              color : '#000', // inner circle color
            },
            slice : {
              radius : 200, // maximum size of the slices
              color : '#000', // slice color
            }
          }
        }
      });

      $('#playlist .playlist a.play-track').live('click', function(e) {
        e.preventDefault();
        e.stopImmediatePropagation();

        $('#playlist .active').removeClass('active');
        $(this).addClass('active');
        player.load($(this).attr('href'), function() {
          $('.play').trigger('mousedown');
        });
        return false;
      });

      $('#playlist #buttons li').click(function(e) {
        e.preventDefault();
        e.stopImmediatePropagation();
        window.location.hash = $(this).find('a').attr('href');
        navigate();

        if ($(this).is('.playlist')) {
          scrollToTrack(0);
        }
        return false;
      });

      $('#playlist #buttons li a').click(function(e) {
        e.preventDefault();
      });

      var navigate = function() {
        $('#playlist .content > *').hide();

        var loc = 'playlist';
        if (window.location.hash.length > 1) {
          loc = window.location.hash.replace('#', '');
        }

        if (loc === 'playlist' && $('.group-list li').length === 0) {
          window.location.hash = '#groups';
          loc = 'groups';
        }

        $('#playlist .content .' + loc).show();
        $('#playlist .content .' + loc).find(':input:first').focus();
        $('#playlist #buttons li.selected').removeClass('selected');
        $('#playlist #buttons li.' + loc).addClass('selected');
      };

      player.el.bind('finished', function() {
        $('#playlist .content a.active').parent().next('li').find('a').click()
      });

      var appendTrack = function(track) {
        var title = track.title;
        title = '[' + storage.groups[track.group].name + '] ' + title;
        $('#playlist ul.playlist').append('<li><a class="play-track" href="' + track.url + '">' + title + '</a></li>');
      };

      var appendGroup = function(name, unique, id, prepend) {
        if (unique !== name) {
          name = name + ' (' + unique + ')';
        }
        // TODO: kick off resolver
        $('.no-groups').hide();
        var markup = '<li class="resolving"><a href="#" class="remove">x</a> <a href="#' + id + '">' + name + '</a></li>';
        $('.group-list').append(markup);
      };

      var tracklist = {};
      $.each(storage.tracks, function(idx, track) {
        tracklist[track.id] = true;
        appendTrack(track);
      });

      $.each(storage.groups, function(id, group) {
        if (!group || !group.name) {
          reset();
          return false;
        }
        appendGroup(group.name, group.unique, id)
      });

      navigate();

      var updateCounts = function(keepcolor) {


        setTimeout(function updateNumbers() {

          var totalGroups = $('.group-list li').length;
          var totalTracks = $('.playlist li').length;
          var groups = parseInt($('#buttons .groups .count').text(), 10);
          var tracks = parseInt($('#buttons .playlist .count').text(), 10);
          var another = false;

          if (groups < totalGroups) {
            another = true;
            $('#buttons .groups .count').text(groups+1);
            if (!keepcolor) {
              $('#buttons .groups .count').addClass('active');
            }
          } else if (groups > totalGroups) {
            another = true;
            $('#buttons .groups .count').text(groups-1);
            if (!keepcolor) {
              $('#buttons .groups .count').addClass('active');
            }
          } else {
            $('#buttons .groups .count').removeClass('active');
          }

          if (tracks < totalTracks) {
            another = true;
            $('#buttons .playlist .count').text(tracks+1);
            if (!keepcolor) {
              $('#buttons .playlist .count').addClass('active');
            }
          } else if (tracks > totalTracks) {
            another = true;
            if (!keepcolor) {
              $('#buttons .playlist .count').addClass('active');
            }
            $('#buttons .playlist .count').text(tracks-1);
          } else {
            $('#buttons .groups .count').removeClass('active');
          }

          if (another) {
            setTimeout(updateNumbers, 0);
          } else {
             $('#buttons .groups .count, #buttons .playlist .count').removeClass('active');
          }
        }, 50);
      };

      updateCounts();

      $('.group-list li a.remove').live('click', function() {
        var groupId = parseInt($(this).next('a').attr('href').replace('#', ''), 10);
        delete storage.groups[groupId];

        if (storage.tracks && storage.tracks.filter) {
          storage.tracks = storage.tracks.filter(function(track) {
            if (track.group === groupId) {
              $('#playlist .playlist a[href="' + track.url + '"]').parent().remove();
              delete tracklist[track.id];
              return false;
            }
            return true;
          });
        }

        if (storage.tracks.length === 0) {
          $('.no-groups').fadeIn();
        }
        save();

        $(this).parent().remove();
        updateCounts();
        return false;
      });

      $('.group-name').bind('keydown', function(e) {
        e.stopPropagation();
        $(this).removeClass('error');
        if (e.keyCode === 13) {
          $('.add-group').click();
        }
      });

      $('.add-group').bind('click', function() {
        var name = $.trim($('.group-name').val());
        if (name === '') {
          $('.group-name').addClass('error');
          return false;
        }

        var url = 'http://soundcloud.com/groups/' + name;
        var ok = false;
        $.ajax({
          url : "http://api.soundcloud.com/resolve.json?client_id=" + player.soundcloud.key + "&url=" + url,
          dataType : 'jsonp',
          success : function(data) {
            if (!storage.groups[data.id]) {
              storage.groups[data.id] = {
                name : data.name,
                unique : data.permalink
              };
              updatePlaylist(data.id);
              appendGroup(data.name, data.permalink, data.id);
              save();
            }

            $('.group-name').val('');
            updateCounts();
          },
        });
      });

      player.el.bind('playing', function(e, data) {
        storage.position = data.value;
        save();
      });

      player.el.bind('trackinfo', function(e, data) {
        storage.current = data.id;
        scrollToTrack();
        save();
      });

      player.el.bind('loaded', scrollToTrack);

      var scrollToTrack = function() {
        var current = $('#playlist .playlist a.active');
        var scroller = current.parents('.scroller');

        var coff = current.offset();
        var poff = current.parents('ul').offset();

        if (coff && poff) {
          scroller.animate({
            scrollTop : (coff.top - poff.top) - scroller.height()*.25
          }, 200);
        }
      };

      player.el.bind('volume', function(e, volume) {
        storage.volume = volume;
        save();
      });

      var updatePlaylist = window.updatePlaylist = function(group_id) {
        if (!group_id) { return; }
        $.ajax({
          url : 'https://api.soundcloud.com/groups/' + group_id + '/tracks.json?client_id=' + player.soundcloud.key,
          dataType : 'json',
          success: function(data) {
            var originalLength = $('#playlist .playlist li').length, track;
            for (var i=0, l=data.length; i<l; i++) {

              if (!tracklist[data[i].id]) {
                track = {
                  id: data[i].id,
                  url : data[i].permalink_url,
                  title : data[i].title,
                  username : data[i].user.username,
                  group : group_id
                };
                storage.tracks.push(track);

                tracklist[data[i].id] = true;
                appendTrack(track)
              }
            }

            save();
            updateCounts();

            if (originalLength === 0) {

              window.location.hash = "#playlist";
              navigate();
              $('#playlist .playlist li:first a').click();
            }
          }
        });
      };

      player.el.bind('finished', function() {
        $.each(storage.groups, function(id, group) {
          updatePlaylist(id);
        })
      });

      updatePlaylist();

      $(window).bind('keydown', function(e) {
        switch (e.keyCode) {
          case 39: // right arrow (next track)
            $('#playlist .content a.active').parent().next('li').find('a').click()
          break;

          case 37: // left arrow (previous track)
            $('#playlist .content a.active').parent().prev('li').find('a').click()
          break;

          case 32:
            player.el.find('.controls .pause:visible, .controls .play:visible').mousedown()
          break;

          case 40: // down arrow (volume down)
            player.volumeControl(player.volumeControl()-5);
          break;

          case 38: // up array (volume up)
            player.volumeControl(player.volumeControl()+5);
          break;

          case 221: // right bracket (jump forward)
            player.progress(player.progress() + 500)
          break;

          case 219: // left bracket (jump backward)
            player.progress(player.progress() - 500)
          break;
        }
      });

      $(window).load(function() {
        var current = storage.tracks.length, tracks = storage.tracks, found;
        while (current--) {
          if (tracks[current].id === storage.current) {
            found = tracks[current];
            break;
          }
        }

        if (found) {
          $('#playlist a[href="' + found.url + '"]').addClass('active');
          player.load(storage.current);
          player.el.one('sound:created', function() {
            player.el.trigger('loading');
            var targetPercent = storage.position/player.sound.meta.duration;
            player.el.bind('buffering', function waitForBuffer(e, o) {
              if (targetPercent < o.value/o.total) {
                player.el.unbind('buffering', waitForBuffer);
                player.sound.setPosition(storage.position);
                player.el.trigger('loaded');
                $('.play').mousedown();
              }
            });
          });
        } else {
          $('#playlist .content a:first').click();
        }
      });
    });
  </script>
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-633948-2']);
    _gaq.push(['_trackPageview']);
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
</body>
</html>