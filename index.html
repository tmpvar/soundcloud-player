<html>
<head>
  <title>player test</title>
  <style>
    #player-container {
      position: absolute;
      width: 1000px;
      height: 1000px;
    }

    #controls img{
      -moz-user-select: none;
      -webkit-user-select: none;
      user-select: none;

      position: absolute;
      z-index : 3;
      left: 0px;
      top: 0px;
    }
    #playerInfoText{
     font-family: helvetica,arial;
     position: absolute;
     text-align: center;
     z-index: 4;
     color: #ffffff;
     width: 300px;
     font-size:30px;
    }
  </style>
  <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
  <script type="text/javascript" src="/sm2/soundmanager2.js"></script>
</head>
<body style="background: #abbbcd">
  <div id="player-container">
    <canvas id='player' style="position:absolute; z-index: 2; top:0; left: 0px"></canvas>
    <canvas id='progress' style="position:absolute; z-index: 1; top:0px; left: 0px"></canvas>
    <div id='playerInfoText'>
      song: this awesome thing
      artist: the testers
    </div>
    <div id="controls">
      <img class="play" src="img/play_balanced.png"/>
      <img class="pause" src="img/pause.png" />
    </div>
  </div>
    <script type="text/javascript">
    soundManager.url = '/sm2/swf/';
    soundManager.flashVersion = 9;
    soundManager.useFlashBlock = false;
  </script>
  <script type="text/javascript">
    $(function() {
      var w = 1000;
      var h = w;
      var offset=w*0.1;
      var center = w/2;
      $('#player-container').css({
        width:w,
        height:h
      });

      var parts = 360;
      var canvas = $('#player')[0];
      var progress = $('#progress')[0];
      canvas.width = w;
      canvas.height = h;
      progress.width = w;
      progress.height = h;

      var ctx = canvas.getContext('2d');
      var pctx = progress.getContext('2d');
      var waveheight = w/6;
      var radius = w/2-waveheight/2;

      $.ajax({
        url      : 'http://api.soundcloud.com/tracks/28597611.json?client_id=bc73a3deaf438619d689a1100a066ce1',
        dataType : 'json',
        success  : function(o) {
          soundManager.onready(function() {
            var soundObject = window.sound = soundManager.createSound({
              id: 'mySound',
              url: o.stream_url + '?client_id=bc73a3deaf438619d689a1100a066ce1',
              autoLoad: true,
              autoPlay: false,
              stream : true,
              onload: function() {
              },
              onplay : function() {
                var that = this;
                var scrub = function(e) {
                  var calculatedRadians = -Math.atan2(e.clientY - center, e.clientX - center);

                  var initialDegrees = (calculatedRadians * (180/Math.PI)) - 90;

                  var correctedDegrees = (initialDegrees < 0) ? initialDegrees + 360 : initialDegrees;
                  var percent = (360 - correctedDegrees)/360;
                  console.log(o.duration, percent, o.duration*percent);
                  that.setPosition(parseInt(o.duration*percent, 10));
                };
                $('#player').bind('mousedown', function(e) {
                  scrub(e);
                  $('#player').bind('mousemove', scrub);
                });

                $('#player').bind('mouseup', function() {
                  $('#player').unbind('mousemove', scrub);
                });
              },
              whileplaying : function() {
                updatePercent((this.position/o.duration)*100);
              },
              volume: 50
            });


            $('#controls').show();
            $('#controls .play').show();
            var played = false;
            var play = function() {
              $('#controls .play').hide();
              $('#controls .pause').show();
              if (!played) {
                soundObject.play();
                played = true;
              } else {
                soundObject.resume();
              }
              return false;
            };

            var pause = function () {
              $('#controls .play').show();
              $('#controls .pause').hide();

              if (played) {
                soundObject.pause();
              }
              return false;
            };

            $('#controls .pause').bind('click', pause);
            $('#controls .play').bind('click', play);

            pause();

          });

          var waveform = new Image();
          waveform.onload = function() {

            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, w, h);
            ctx.translate(center, center);

            ctx.fillStyle = "black";
            ctx.globalCompositeOperation = 'destination-in';
            var width = waveform.width/parts;

            for (var i=0; i<parts; i++) {
              ctx.save();
              ctx.rotate(i * 360/parts * Math.PI/180);
              ctx.translate(0, -radius/1.1);
              ctx.drawImage(waveform, i*width, 0, width, waveheight, 0, 0, width, waveheight);
              ctx.restore();
            }

            ctx.globalCompositeOperation = 'source-out';
            ctx.beginPath();
            ctx.arc(0,0, (radius), 0, Math.PI*2, true);
            ctx.closePath();
            ctx.fillStyle = "black";
            ctx.fill();
          };
          waveform.src = o.waveform_url;
          $('#playerInfoText').css('width', radius/2);
          $('#playerInfoText').css({
            left  : center-$('#playerInfoText').width()/2,
            top   : center+radius/5,
            "font-size": radius/25 

          })
        $('#playerInfoText').html(o.title+"<br>"+"<br>"+o.description.replace(o.title, ''))
        }
      });

      function updatePercent(percent) {
        pctx.save();
          pctx.beginPath();
          pctx.arc(center, center, (radius/1.1), 0, Math.PI*2, true);
          pctx.closePath();
          pctx.fillStyle = "white";
          pctx.fill();

          pctx.save();
            pctx.beginPath();
            pctx.translate(center, center);
            pctx.arc(0,0, radius/1.0978, -Math.PI*.5, ((percent/100) * (Math.PI*2)) -Math.PI*.5, false);
            pctx.lineTo(0, 0);
            pctx.closePath();
            pctx.fillStyle = "#920B0D";
            pctx.fill();

          pctx.restore();

          pctx.beginPath();
          pctx.arc(center,center, (radius/1.5), 0, Math.PI*2, true);
          pctx.closePath();
          pctx.fillStyle = "rgba(0, 0, 0, 0.3)";
          pctx.fill();

          pctx.beginPath();
          pctx.arc(center,center, (radius/2), 0, Math.PI*2, true);
          pctx.closePath();
          pctx.fillStyle = "black";
          pctx.fill();
        pctx.restore();
      }
      updatePercent(0);

      $('img').bind('dragstart', function(event) { event.preventDefault() })
      $('#controls .play').css({ width : offset, height : offset});
      $('#controls .play').css({
        left  : center - $('#controls .play').width()/2,
        top   : center - $('#controls .play').height()/2
      });
       $('#controls .pause').css({ width : offset , height: offset});
      $('#controls .pause').css({
        left  : center - $('#controls .pause').width()/2,
        top   : center - $('#controls .pause').height()/2
      })  

    });
  </script>
</body>
</html>